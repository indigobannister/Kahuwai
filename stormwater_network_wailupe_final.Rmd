---
title: "stormwater_network_wailupe_final"
author: "Erica Johnson"
date: "5/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Read libraries and data file here
```{r, include=FALSE}
#Libraries
library(tidyverse)
library(dplyr)
library(data.table)
library(geosphere)
library(janitor)



#Data with clean names
data <- read_csv("stormwater_network_wailupe.csv") %>% clean_names()
verticesdata <- read_csv("stormwater_network_allpoints_wailupe.csv") %>% clean_names()

```

Select columns with the data we need to use. Rename them for easy reference.
```{r}
network <- data %>% 
  select(
  objectid,
  point_x,
  point_y,
  elevation,
  subcatch_r,
  roughness,
  type,
  diameter,
  width,
  height,
  type_1
  ) %>% 
  rename(
    name = objectid,
    x = point_x,
    y = point_y,
    subc = subcatch_r,
    elevation = elevation,
    shape = type,
    structure = type_1
    ) %>% 
  mutate (shape = str_replace_all(shape, "Reinforced Concrete Pipe", "CIRCULAR")) %>% 
  mutate (shape = str_replace_all(shape, "Box Culvert", "RECT_CLOSED")) %>% 
  mutate (shape = str_replace_all(shape, "Channel", "TRAPEZOIDAL")) %>% 
  mutate (shape = str_replace_all(shape, "Ditch", "RECT_OPEN")) %>% 
  mutate (shape = str_replace_all(shape, "Other", "RECT_OPEN")) %>% 
  distinct()

#Add the rest of the columns we need. SWMM does not take "NA" the default blank value for R, so we populate columns with 0 for now.
network$initflow <- 0
network$maxflow <- 0
network$length <- 0
network$inoffset <- 0
network$outoffset <- 0
```

"Length" provided by USGS is distance between xy points. This "length"" is not the actual length of the conduit because it does not take into consideration height (xyz), so we will use the difference between lower distance between xy points calcualte the actual length further down in the code.  

We will also re-calculate distance between xy points because different sources return  different values for some of the conduits and some conduits need to have this distance calculated anyway because it is blank. 

Step 1 - Create unique names for nodes with the same x and y coordinates, and unique names for conduits

```{r}
#Index xy coordinates with unique IDs if different, same IDs if repeated
unique <- network %>% 
  mutate(
    node = group_indices(
      network, x, y
      )
    ) 
#assign nodes the letter j for "junction" (SWMM terminology) and conduits the letter c for "conduit" (SWMM terminology)

unique$c <- "C"
unique$j <- "J"

#conduits
unique$name= paste(unique$c,unique$name)

#remove space
unique$name <- gsub(
  '\\s+', '', unique$name
  )
#node
unique$node= paste(unique$j,unique$node)

#remove space
unique$node <- gsub(
  '\\s+', '', unique$node
  )

```

2. Arrange and reshape data 
Note: each conduit has start and end coordinates and nodes, - so there are duplicate rows for each conduit. We want to reshape this data to have both xy and nodes in the same row.


# dcast will reshape or merge duplicate data (in this case "Name) and create a column for any unique data attached to "Name". It will use the variable "Node" and name unique values of nodes in numerical order.

match_nodes <- dcast(setDT(arranged), Name~rowid(Name, prefix="Nodes"), value.var="Nodes")

#make a table with both x and y coordinates in one row

match_x <- dcast(setDT(conduits), Name~rowid(Name, prefix="POINT_X"), value.var="POINT_X")

match_y <- dcast(setDT(conduits), Name~rowid(Name, prefix="POINT_Y"), value.var="POINT_Y")

#The match function will only have the two variables. We will need to merge conduit and "match"" data tables together using the merge function.

merge_XY <-merge(match_x, match_y, by = "Name")

merge_XY_nodes <-merge(merge_XY, match_nodes, by = "Name")


```{r}
#arrange by conduit name and descending elevation
arrange <- unique[
  with(
  unique, order(
    name, 
    -elevation, 
    na.last=FALSE)
  ),
  ]


reshape_datan <- dcast(setDT(arrange), name~rowid(name, prefix="node"), value.var="node")

reshape_datax <- dcast(setDT(arrange), name~rowid(name, prefix="x"), value.var="x")

reshape_datay <- dcast(setDT(arrange), name~rowid(name, prefix="y"), value.var="y")

reshape_datae <- dcast(setDT(arrange), name~rowid(name, prefix="elevation"), value.var="elevation")

merge_xy <- merge(reshape_datax, reshape_datay, by = "name")

merge_n <- merge(merge_xy, reshape_datan, by = "name")


```

reshape <- arrange %>% 
   mutate(
    con1 = row_number()
    ) %>% 
  mutate(
      con2 = row_number()-1
      )

con1 <- reshape %>%  select(
  name,
  con1, 
  x, 
  y, 
  elevation, 
  node, 
  roughness,
  shape,
  diameter,
  width,
  height,
  structure
  )


con2 <- reshape %>%  select(
  con2,
  x, 
  y, 
  elevation, 
  node) %>% 
  rename(
    con1 = con2
    )

merge<- merge(con1, con2, by = "con1")  %>% 
  distinct(
    name,
    node.x,
    .keep_all = TRUE
    )

3. Length

We must now calculate the length of the conduits using the following steps:
a. Find distance "length" between xy coordinates of each conduit using geosphere.
b. Use difference in elevation to calculate height
c. Use pythag. theorem to calculate length

```{r}
#part a -  distance (adjust code based on number of pairs. This dataset has 18 based on the longest conduit)
dist <- merge_n %>%  
  rowwise(
  ) %>% 
  mutate (
    dist_m = distm(c(x1, y1), 
                   c(x2, y2), 
                   fun = distHaversine
                   )
    ) %>% 
  mutate(
    dist_ft = dist_m*3.28084
    )

#part b and c - height then length
lengths <- dist %>%  
  mutate (
    length = sqrt(
      (dist_ft)^2 + (elevation.x-elevation.y)^2)
          )%>% 
  rename (
    from_node = node.x,
    to_node = node.y,
    subc = subc.x
  )

```

4. file output for conduits
[CONDUITS]								
;;Name  From Node To Node  Length Roughness InOffset  OutOffset InitFlow  MaxFlow
;;---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------

Use roughness value 0.01, for concrete pipes found in Appendix A-8 pg. 184 of EPA manual
```{r}
conduits <- lengths %>% 
  mutate(
    roughness = ifelse(is.na(roughness), 
                       0.01, 
                       roughness
                       )
    ) %>% 
  select(
    name,
    from_node, 
    to_node,
    length, 
    roughness 
    ) 

conduits$inoffset <- 0
conduits$outoffset <- 0
conduits$initflow <- 0
conduits$maxflow <- 0


write.csv(conduits,"conduits.csv", row.names = FALSE)
```

5. file output for lengths
[XSECTIONS]							
;;Link  Shape	Geom1	Geom2	Geom3 Geom4 Barrels Culvert   
;;--------------	------------	----------------	----------

a - concrete pipe dimensions
```{r}
pipes<- lengths %>% 
  filter(
    shape == "CIRCULAR"
    ) %>% 
  rename(
    geom1 = diameter,
    link = name
    ) %>%
  mutate(
    geom1 = ifelse(is.na(geom1), "23", geom1)
    ) %>% 
  mutate(
    geom1 = ifelse((geom1=="Other"), "23", (geom1))
    )%>% 
  select(
    link, 
    shape,
    subc,
    length,
    geom1
  )
pipes$geom2 <- 0
pipes$geom3 <- 0
pipes$geom4 <- 0
pipes$barrels <- 
pipes$culvert <- 0
```

b - box culverts, ditches, and "other" conduit dimensions
```{r}
ditch_box <- lengths %>% 
  filter(
    shape == "RECT_CLOSED" | shape == "RECT_OPEN"
    ) %>% 
  rename (
    geom1 = width, 
    geom2 = height,
    link = name
    ) %>% 
  mutate(
    geom1 = ifelse(is.na(geom1), 5, geom1)
    ) %>% 
  mutate(geom2 = ifelse(is.na(geom2), 5, geom2)
         ) %>% 
  select( 
    link, 
    shape, 
    subc,
    length,
    geom1,
    geom2
    
  )
ditch_box$geom3 <- 0
ditch_box$geom4 <- 0
ditch_box$barrels <- 
ditch_box$culvert <- 0
```


c - channel (channelized stream) dimenssions
```{r}
channel <- lengths %>% 
  filter(
    is.na(shape)
    ) %>% 
  mutate(
    shape = ifelse(is.na(shape), "TRAPEZOIDAL", shape)
    ) %>% 
  rename(
    geom1 = width, 
    geom2 = height,
    link = name
    ) %>% 
  mutate(
    geom1 = ifelse(is.na(geom1), 30, geom1)
    ) %>% 
  mutate(
    geom2 = ifelse(is.na(geom2), 10, geom2)
    ) %>% 
  select(
     link, 
    shape,
    subc,
    length,
    geom1,
    geom2
    )
#Geom3 and Geom4 are side lopes, which literature indicate vary from 1/1 to 1/2.  Ive seen side slopes perpendicular to the ground, especially where homes are built.
channel$geom3 <- 1
channel$geom4 <- 1
channel$barrels <- 
channel$culvert <- 0
```
e- bind all tables

```{r}
xsections_df <- rbind(
  pipes, 
  ditch_box, 
  channel
  ) %>% 
  select(
    link, 
    shape, 
    geom1, 
    geom2, 
    geom3, 
    geom4, 
    barrels, 
    culvert, 
    subc, 
    length
    ) %>%  
  distinct(
    link, 
    shape, 
    geom1, 
    geom2, 
    .keep_all = TRUE
    )

xsections <- rbind(
  pipes, 
  ditch_box, 
  channel
  ) %>% 
  select(
    link, 
    shape, 
    geom1, 
    geom2, 
    geom3, 
    geom4, 
    barrels, 
    culvert
    ) %>% 
  distinct(
    link, 
    shape, 
    geom1, 
    geom2, 
    .keep_all = TRUE
    )

write.csv(xsections,"xsections.csv", row.names = FALSE)
```


8. Junctions and coordinates/vertices

[JUNCTIONS]					
;;Name  Elevation MaxDepth  InitDepth SurDepth  Aponded   
;;--------------	----------	----------	----------	
```{r}

junctions <- con1 %>% 
  filter(
    structure != "Inlet/Outlet"
    ) %>% 
  select(
    node, 
    elevation
    ) %>% 
  rename(
    name = node
    )
junctions$maxdepth <- 0
junctions$initdepth <- 0
junctions$surdepth <- 0
junctions$aponded <- 0

#filter for structure type in here so we can designate which junctions are outfalls
write.csv(junctions,"junctions.csv", row.names = FALSE)
```

[OUTFALLS]					
;;Name          	Elevation 	Type      	Stage Data      	Gated   	Route To     
;;--------------	----------	----------	----------------	--------	----------------
```{r}
outfalls <- unique %>% 
   filter(
    structure == "Inlet/Outlet"
    ) %>% 
  select(
    node, 
    elevation
    ) %>% 
  rename(
    name = node
    )
outfalls$type <- "FREE"
outfalls$stagedata <- NA
outfalls$gated <- "NO"
outfalls$routeto <- NA

#you will need to check these structures in SWMM. If these structures are at an end of a conduit, then they are outfalls, otherwise you can quickly turn them back into a junction in SWMM.

write.csv(outfalls,"outfalls.csv", row.names = FALSE)
```

[COORDINATES]		
;;Node          	X-Coord           	Y-Coord           
;;--------------	------------------	------------------

SWMM takes x and y that are in decimal degrees  (lat and long).
```{r}
coordinates <- unique %>% 
  select(
    node, 
    x, 
    y
    )

write.csv(coordinates,"coordinates.csv", row.names = FALSE)
```

[VERTICES]		
;;Link          	X-Coord           	Y-Coord           
;;--------------	------------------	------------------
```{r}
vertices <- verticesdata %>%
  select(
    objectid,
    point_x,
    point_y
  ) %>% 
  rename(
   link = objectid,
   x = point_x,
   y = point_y
    ) 
vertices$c <- "C"

#conduits
vertices$link <- apply(
  vertices,1,function(x) paste((x[4]), sep ="",(x[1]))
  ) 

#remove space
vertices$link <- gsub(
  '\\s+', '', vertices$link
  ) 
 
  vertices1 <- vertices %>% 
  select(
    link,
    x,
    y
  )

write.csv(vertices1,"vertices.csv", row.names = FALSE)
```
